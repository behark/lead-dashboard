{% extends "base.html" %}

{% block title %}Database Backups{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2><i class="bi bi-database"></i> Database Backups</h2>
            <p class="text-muted">Manage database backups and restore points</p>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Backup Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 mb-3">
                        <button id="createBackupBtn" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Create Backup Now
                        </button>
                        <button id="cleanupBackupsBtn" class="btn btn-secondary">
                            <i class="bi bi-trash"></i> Cleanup Old Backups
                        </button>
                    </div>
                    <div id="backupStatus" class="alert" style="display: none;"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Available Backups</h5>
                </div>
                <div class="card-body">
                    {% if backups %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th>Size</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for backup in backups %}
                                <tr>
                                    <td>{{ backup.filename }}</td>
                                    <td>{{ "%.2f"|format(backup.size / 1024 / 1024) }} MB</td>
                                    <td>{{ backup.created }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No backups found. Create your first backup above.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('createBackupBtn').addEventListener('click', function() {
    const btn = this;
    const status = document.getElementById('backupStatus');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';
    
    fetch('{{ url_for("backup.create_backup") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.className = 'alert alert-success';
            status.textContent = data.message;
            status.style.display = 'block';
            setTimeout(() => location.reload(), 2000);
        } else {
            status.className = 'alert alert-danger';
            status.textContent = 'Error: ' + (data.error || 'Unknown error');
            status.style.display = 'block';
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-plus-circle"></i> Create Backup Now';
    })
    .catch(error => {
        status.className = 'alert alert-danger';
        status.textContent = 'Error: ' + error.message;
        status.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-plus-circle"></i> Create Backup Now';
    });
});

document.getElementById('cleanupBackupsBtn').addEventListener('click', function() {
    if (!confirm('Delete backups older than 30 days?')) return;
    
    const btn = this;
    const status = document.getElementById('backupStatus');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Cleaning...';
    
    fetch('{{ url_for("backup.cleanup_backups") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: 'keep_days=30'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.className = 'alert alert-success';
            status.textContent = data.message;
            status.style.display = 'block';
            setTimeout(() => location.reload(), 2000);
        } else {
            status.className = 'alert alert-danger';
            status.textContent = 'Error: ' + (data.error || 'Unknown error');
            status.style.display = 'block';
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-trash"></i> Cleanup Old Backups';
    })
    .catch(error => {
        status.className = 'alert alert-danger';
        status.textContent = 'Error: ' + error.message;
        status.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-trash"></i> Cleanup Old Backups';
    });
});
</script>
{% endblock %}
