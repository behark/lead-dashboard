{% extends "base.html" %}

{% block title %}Leads - Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4>Lead Dashboard <small class="text-muted fs-6">{{ stats.total }} total leads</small></h4>
    <div>
        <a href="{{ url_for('bulk.bulk_send') }}" class="btn btn-success">
            <i class="bi bi-send-fill"></i> Bulk Send
        </a>
    </div>
</div>

<!-- Stats Row -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="stat-card bg-primary text-white">
            <h3>{{ stats.total }}</h3>
            <small>Total Leads</small>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card stat-hot">
            <h3>{{ stats.by_temperature.HOT|default(0) }}</h3>
            <small>HOT</small>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card bg-secondary text-white">
            <h3>{{ stats.by_status.NEW|default(0) }}</h3>
            <small>NEW</small>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card bg-info text-white">
            <h3>{{ stats.by_status.CONTACTED|default(0) }}</h3>
            <small>CONTACTED</small>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card bg-warning">
            <h3>{{ stats.by_status.REPLIED|default(0) }}</h3>
            <small>REPLIED</small>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stat-card bg-success text-white">
            <h3>{{ stats.by_status.CLOSED|default(0) }}</h3>
            <small>CLOSED</small>
        </div>
    </div>
</div>

<!-- Conversion & Attention Row -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="metric-card">
            <div class="row text-center">
                <div class="col-6">
                    <h4 class="text-primary">{{ stats.conversion.response_rate }}%</h4>
                    <small class="text-muted">Response Rate</small>
                </div>
                <div class="col-6">
                    <h4 class="text-success">{{ stats.conversion.close_rate }}%</h4>
                    <small class="text-muted">Close Rate</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="metric-card">
            <small class="text-muted">Recent Activity (7 days)</small>
            <div class="d-flex justify-content-around mt-2">
                <div class="text-center">
                    <strong>{{ stats.recent_activity.new_leads }}</strong>
                    <br><small>New</small>
                </div>
                <div class="text-center">
                    <strong>{{ stats.recent_activity.contacts_made }}</strong>
                    <br><small>Contacts</small>
                </div>
                <div class="text-center">
                    <strong>{{ stats.recent_activity.responses }}</strong>
                    <br><small>Responses</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        {% if attention.hot_neglected %}
        <div class="metric-card attention-card">
            <small class="text-danger"><i class="bi bi-exclamation-triangle"></i> Needs Attention</small>
            <div class="mt-2">
                <strong>{{ attention.hot_neglected|length }}</strong> hot leads not contacted recently
            </div>
            <a href="?temp=HOT&status=NEW" class="btn btn-sm btn-outline-danger mt-2">View</a>
        </div>
        {% else %}
        <div class="metric-card">
            <small class="text-success"><i class="bi bi-check-circle"></i> All Good</small>
            <div class="mt-2">No urgent leads needing attention</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Filters -->
<div class="filter-bar">
    <div class="mb-2">
        <label class="form-label">Saved Selections:</label>
        <div class="btn-group me-2" role="group" id="savedFiltersGroup">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="newFilterBtn" onclick="showSaveFilterModal()">
                <i class="bi bi-bookmark-plus"></i> Save Current
            </button>
        </div>
        <small class="text-muted">(Saved filters will appear here)</small>
    </div>
    
    <form method="GET" action="{{ url_for('main.index') }}" class="row g-2 align-items-center">
        <div class="col-md-2">
            <input type="text" name="search" class="form-control" placeholder="Search name..." value="{{ search_query }}">
        </div>
        <div class="col-md-2">
            <select name="country" class="form-select">
                <option value="">All Countries</option>
                {% for country in countries %}
                <option value="{{ country }}" {% if current_filters.country == country %}selected{% endif %}>{{ country }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select name="category" class="form-select">
                <option value="">All Categories</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {% if current_filters.category == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-1">
            <select name="status" class="form-select">
                <option value="">Status</option>
                <option value="NEW" {% if current_filters.status == 'NEW' %}selected{% endif %}>NEW</option>
                <option value="CONTACTED" {% if current_filters.status == 'CONTACTED' %}selected{% endif %}>CONTACTED</option>
                <option value="REPLIED" {% if current_filters.status == 'REPLIED' %}selected{% endif %}>REPLIED</option>
                <option value="CLOSED" {% if current_filters.status == 'CLOSED' %}selected{% endif %}>CLOSED</option>
                <option value="LOST" {% if current_filters.status == 'LOST' %}selected{% endif %}>LOST</option>
            </select>
        </div>
        <div class="col-md-1">
            <select name="temp" class="form-select">
                <option value="">Temp</option>
                <option value="HOT" {% if current_filters.temp == 'HOT' %}selected{% endif %}>HOT</option>
                <option value="WARM" {% if current_filters.temp == 'WARM' %}selected{% endif %}>WARM</option>
                <option value="COLD" {% if current_filters.temp == 'COLD' %}selected{% endif %}>COLD</option>
            </select>
        </div>
        <div class="col-md-2">
            <select name="assigned" class="form-select">
                <option value="">All Assigned</option>
                <option value="mine" {% if current_filters.assigned == 'mine' %}selected{% endif %}>My Leads</option>
                <option value="unassigned" {% if current_filters.assigned == 'unassigned' %}selected{% endif %}>Unassigned</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if current_filters.assigned == user.id|string %}selected{% endif %}>{{ user.username }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-1">
            <select name="sort" class="form-select">
                <option value="score" {% if current_filters.sort == 'score' %}selected{% endif %}>Score</option>
                <option value="date" {% if current_filters.sort == 'date' %}selected{% endif %}>Date</option>
                <option value="followup" {% if current_filters.sort == 'followup' %}selected{% endif %}>Follow-up</option>
            </select>
        </div>
        <div class="col-md-1">
            <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>
    </form>
    <div class="mt-2">
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-sm">Clear</a>
        <span class="text-muted ms-3">Page {{ pagination.page }}/{{ pagination.pages }} ({{ pagination.total }} results)</span>
    </div>
</div>

<!-- Selection Info Bar -->
<div class="alert alert-info d-none" id="selectionBar" role="alert">
    <div class="d-flex justify-content-between align-items-center">
        <span>
            <strong id="selectedCount">0</strong> leads selected
            <span class="ms-2">
                <a href="#" onclick="toggleSelectAll(false); return false;" class="text-decoration-none">Deselect All</a> | 
                <a href="#" onclick="showSaveFilterModal(); return false;" class="text-decoration-none">Save Selection</a>
            </span>
        </span>
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-info" id="showKbShortcuts" title="Keyboard shortcuts (?)">
                <i class="bi bi-keyboard"></i> Help
            </button>
        </div>
    </div>
</div>

<!-- Bulk Actions -->
<form method="POST" action="{{ url_for('main.bulk_action') }}" id="bulkForm">
    <div class="d-flex gap-2 mb-3">
        <select name="action" class="form-select form-select-sm" style="width: auto;" id="bulkAction">
            <option value="">Bulk Action...</option>
            <option value="personal_whatsapp">üì± Send via Personal WhatsApp</option>
            <option value="assign">Assign to User</option>
            <option value="status">Change Status</option>
            <option value="enroll_sequence">Enroll in Sequence</option>
            <option value="recalculate_scores">Recalculate Scores</option>
        </select>
        <select name="assign_to" class="form-select form-select-sm d-none" style="width: auto;" id="assignSelect">
            <option value="">Select User</option>
            {% for user in users %}
            <option value="{{ user.id }}">{{ user.username }}</option>
            {% endfor %}
        </select>
        <select name="new_status" class="form-select form-select-sm d-none" style="width: auto;" id="statusSelect">
            <option value="NEW">NEW</option>
            <option value="CONTACTED">CONTACTED</option>
            <option value="REPLIED">REPLIED</option>
            <option value="CLOSED">CLOSED</option>
            <option value="LOST">LOST</option>
        </select>
        <select name="sequence_id" class="form-select form-select-sm d-none" style="width: auto;" id="sequenceSelect">
            <option value="">Select Sequence</option>
            <!-- Populated dynamically -->
        </select>
        <button type="submit" class="btn btn-sm btn-outline-primary">Apply</button>
        <button type="button" class="btn btn-sm btn-success" id="waBtn" onclick="openSelectedWhatsApp()" title="Open WhatsApp for all selected leads">
            <i class="bi bi-whatsapp"></i> Open WhatsApp for Selected
        </button>
        <span id="waProgress" class="d-none ms-2 badge bg-success fs-6 align-middle"></span>
        <button type="button" class="btn btn-sm btn-danger d-none ms-1" id="waStop" onclick="stopWhatsApp()">
            <i class="bi bi-stop-fill"></i> Stop
        </button>
    </div>

    <!-- Leads Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover lead-table mb-0">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll"></th>
                        <th>Name</th>
                        <th>Contact</th>
                        <th>Location</th>
                        <th>Category</th>
                        <th>Score</th>
                        <th>Status</th>
                        <th>Assigned</th>
                        <th>Follow-up</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for lead in leads %}
                <tr class="{% if lead.temperature.value == 'HOT' %}temp-hot{% elif lead.temperature.value == 'WARM' %}temp-warm{% else %}temp-cold{% endif %}" data-whatsapp="{{ lead.whatsapp_link or '' }}">
                    <td><input type="checkbox" name="lead_ids" value="{{ lead.id }}" class="lead-checkbox"></td>
                    <td>
                        <a href="{{ url_for('main.lead_detail', lead_id=lead.id) }}">
                            <strong>{{ lead.name }}</strong>
                        </a>
                        {% if lead.rating %}
                        <br><small class="text-muted">{{ lead.rating }}‚≠ê</small>
                        {% endif %}
                    </td>
                    <td>
                        {{ lead.phone }}
                        {% if lead.email %}<br><small>{{ lead.email }}</small>{% endif %}
                    </td>
                    <td>
                        {{ lead.city }}
                        <br><span class="badge bg-info">{{ lead.country }}</span>
                    </td>
                    <td>{{ lead.category }}</td>
                    <td>
                        <strong>{{ lead.lead_score }}</strong>
                        <br><span class="badge {% if lead.temperature.value == 'HOT' %}bg-danger{% elif lead.temperature.value == 'WARM' %}bg-warning text-dark{% else %}bg-info{% endif %}">{{ lead.temperature.value }}</span>
                    </td>
                    <td>
                        <span class="badge {% if lead.status.value == 'NEW' %}bg-secondary{% elif lead.status.value == 'CONTACTED' %}bg-info{% elif lead.status.value == 'REPLIED' %}bg-warning text-dark{% elif lead.status.value == 'CLOSED' %}bg-success{% else %}bg-dark{% endif %}">
                            {{ lead.status.value }}
                        </span>
                    </td>
                    <td>
                        {% if lead.assigned_user %}
                        {{ lead.assigned_user.username }}
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if lead.next_followup %}
                        <small>{{ lead.next_followup.strftime('%m/%d') }}</small>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            {% if lead.whatsapp_link %}
                            <a href="{{ lead.whatsapp_link }}" target="_blank" class="btn btn-success" title="Open WhatsApp Chat">
                                <i class="bi bi-whatsapp"></i>
                            </a>
                            {% endif %}
                            <button class="btn btn-outline-danger" onclick="hideLead({{ lead.id }}, this)" title="Hide Lead">
                                <i class="bi bi-eye-slash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</form>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('main.index', page=pagination.prev_num, **current_filters) }}">Previous</a>
        </li>
        {% endif %}
        
        {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p %}
                {% if p == pagination.page %}
                <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="{{ url_for('main.index', page=p, **current_filters) }}">{{ p }}</a></li>
                {% endif %}
            {% else %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('main.index', page=pagination.next_num, **current_filters) }}">Next</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% endblock %}

<!-- Save Filter Modal -->
<div class="modal fade" id="saveFilterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save Filter Selection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="saveFilterForm" method="POST" action="{{ url_for('main.save_filter') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Selection Name:</label>
                        <input type="text" class="form-control" name="filter_name" placeholder="e.g., Hot Leads This Week" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description:</label>
                        <textarea class="form-control" name="filter_desc" rows="2" placeholder="Optional description"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_favorite" id="isFavorite">
                        <label class="form-check-label" for="isFavorite">Mark as favorite</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Selection</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div class="modal fade" id="shortcutsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Keyboard Shortcuts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tbody>
                            <tr><td><kbd>B</kbd></td><td>Open bulk menu</td></tr>
                            <tr><td><kbd>S</kbd></td><td>Select/Deselect all</td></tr>
                            <tr><td><kbd>Ctrl</kbd> + <kbd>Z</kbd></td><td>Undo last action</td></tr>
                            <tr><td><kbd>Ctrl</kbd> + <kbd>Enter</kbd></td><td>Execute bulk action</td></tr>
                            <tr><td><kbd>?</kbd></td><td>Show this help</td></tr>
                            <tr><td><kbd>M</kbd></td><td>Open message composer</td></tr>
                            <tr><td><kbd>N</kbd></td><td>Create new lead</td></tr>
                            <tr><td><kbd>F</kbd></td><td>Focus search</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// ===== SELECTION MANAGEMENT =====
function updateSelectionCount() {
    const selected = document.querySelectorAll('.lead-checkbox:checked').length;
    const bar = document.getElementById('selectionBar');
    const count = document.getElementById('selectedCount');
    
    count.textContent = selected;
    if (selected > 0) {
        bar.classList.remove('d-none');
    } else {
        bar.classList.add('d-none');
    }
    return selected;
}

function toggleSelectAll(selectValue) {
    document.querySelectorAll('.lead-checkbox').forEach(cb => cb.checked = selectValue);
    updateSelectionCount();
}

document.getElementById('selectAll').addEventListener('change', function() {
    toggleSelectAll(this.checked);
});

document.querySelectorAll('.lead-checkbox').forEach(cb => {
    cb.addEventListener('change', updateSelectionCount);
});

// ===== SAVE FILTER =====
function showSaveFilterModal() {
    const modal = new bootstrap.Modal(document.getElementById('saveFilterModal'));
    modal.show();
}

document.getElementById('saveFilterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    formData.append('filters', JSON.stringify(getActiveFilters()));
    
    fetch('{{ url_for("main.save_filter") }}', {
        method: 'POST',
        body: new URLSearchParams(formData)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Selection saved!');
            bootstrap.Modal.getInstance(document.getElementById('saveFilterModal')).hide();
            location.reload();
        }
    });
});

function getActiveFilters() {
    return {
        search: document.querySelector('input[name="search"]').value,
        country: document.querySelector('select[name="country"]').value,
        category: document.querySelector('select[name="category"]').value,
        status: document.querySelector('select[name="status"]').value,
        temp: document.querySelector('select[name="temp"]').value,
        assigned: document.querySelector('select[name="assigned"]').value,
        sort: document.querySelector('select[name="sort"]').value
    };
}

// ===== KEYBOARD SHORTCUTS =====
document.getElementById('showKbShortcuts').addEventListener('click', function(e) {
    e.preventDefault();
    const modal = new bootstrap.Modal(document.getElementById('shortcutsModal'));
    modal.show();
});

document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    if (e.key === 'B' || e.key === 'b') {
        document.getElementById('bulkAction').focus();
        e.preventDefault();
    }
    if (e.key === 'S' || e.key === 's') {
        const selectAll = document.getElementById('selectAll');
        selectAll.checked = !selectAll.checked;
        selectAll.dispatchEvent(new Event('change'));
        e.preventDefault();
    }
    if (e.ctrlKey && e.key === 'z') {
        alert('Undo not yet implemented. Coming soon!');
        e.preventDefault();
    }
    if (e.ctrlKey && e.key === 'Enter') {
        document.querySelector('button[type="submit"]').click();
        e.preventDefault();
    }
    if (e.key === '?' || e.key === '/') {
        const modal = new bootstrap.Modal(document.getElementById('shortcutsModal'));
        modal.show();
        e.preventDefault();
    }
    if (e.key === 'F' || e.key === 'f') {
        document.querySelector('input[name="search"]').focus();
        e.preventDefault();
    }
});

// Initialize
document.getElementById('bulkAction').addEventListener('change', function() {
    document.getElementById('assignSelect').classList.toggle('d-none', this.value !== 'assign');
    document.getElementById('statusSelect').classList.toggle('d-none', this.value !== 'status');
    document.getElementById('sequenceSelect').classList.toggle('d-none', this.value !== 'enroll_sequence');
});

// Open WhatsApp for all selected leads using a single reusable tab
let waTimers = [];
let waSending = false;

function openSelectedWhatsApp() {
    const checked = document.querySelectorAll('.lead-checkbox:checked');
    if (checked.length === 0) {
        alert('Please select at least one lead first.');
        return;
    }

    const links = [];
    checked.forEach(cb => {
        const row = cb.closest('tr');
        const waLink = row.dataset.whatsapp;
        if (waLink) links.push(waLink);
    });

    if (links.length === 0) {
        alert('None of the selected leads have a WhatsApp link.');
        return;
    }

    if (!confirm(`Send WhatsApp to ${links.length} lead(s)?\n\nA single tab will cycle through each lead every 1.5 seconds, triggering your WhatsApp Desktop app.`)) return;

    waSending = true;
    waTimers = [];
    const progressEl = document.getElementById('waProgress');
    const stopBtn = document.getElementById('waStop');
    const waBtn = document.getElementById('waBtn');

    progressEl.classList.remove('d-none');
    stopBtn.classList.remove('d-none');
    waBtn.disabled = true;

    // Open first link in a named reusable window
    const waWindow = window.open(links[0], 'wa_sender');
    progressEl.textContent = `1 / ${links.length}`;

    // Navigate the same window to each subsequent link
    for (let i = 1; i < links.length; i++) {
        const timer = setTimeout(() => {
            if (!waSending) return;
            try {
                waWindow.location.href = links[i];
            } catch(e) {
                // Fallback if cross-origin blocks location change
                window.open(links[i], 'wa_sender');
            }
            progressEl.textContent = `${i + 1} / ${links.length}`;

            // Done - clean up after last one
            if (i === links.length - 1) {
                setTimeout(() => {
                    finishWhatsApp(waWindow);
                }, 2000);
            }
        }, i * 1500);
        waTimers.push(timer);
    }

    // If only 1 link, finish immediately
    if (links.length === 1) {
        setTimeout(() => finishWhatsApp(waWindow), 2000);
    }
}

function stopWhatsApp() {
    waSending = false;
    waTimers.forEach(t => clearTimeout(t));
    waTimers = [];
    finishWhatsApp(null);
}

function finishWhatsApp(waWindow) {
    waSending = false;
    const progressEl = document.getElementById('waProgress');
    const stopBtn = document.getElementById('waStop');
    const waBtn = document.getElementById('waBtn');

    progressEl.textContent = 'Done!';
    waBtn.disabled = false;
    stopBtn.classList.add('d-none');

    // Close the helper tab
    if (waWindow) {
        try { waWindow.close(); } catch(e) {}
    }

    setTimeout(() => progressEl.classList.add('d-none'), 3000);
}

// Hide lead from list
function hideLead(leadId, btn) {
    if (!confirm('Hide this lead from the list?')) return;
    
    const row = btn.closest('tr');
    
    fetch(`/api/lead/${leadId}/hide`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            row.style.transition = 'opacity 0.3s ease';
            row.style.opacity = '0';
            setTimeout(() => row.remove(), 300);
        } else {
            alert('Failed to hide lead.');
        }
    })
    .catch(() => alert('Error hiding lead. Please try again.'));
}
</script>
{% endblock %}
