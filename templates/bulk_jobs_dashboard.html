{% extends "base.html" %}

{% block title %}Bulk Operations Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4>Bulk Operations Dashboard</h4>
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
</div>

<!-- Active Jobs -->
{% if active_jobs %}
<div class="mb-4">
    <h5>Active Operations</h5>
    <div class="row">
        {% for job in active_jobs %}
        <div class="col-md-6 mb-3">
            <div class="card border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="card-title text-capitalize">{{ job.job_type }}</h6>
                            <small class="text-muted">Started: {{ job.started_at.strftime('%H:%M:%S') }}</small>
                        </div>
                        <span class="badge bg-info">{{ job.status.upper() }}</span>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">Progress</small>
                            <small class="text-muted">{{ job.processed_items }}/{{ job.total_items }}</small>
                        </div>
                        <div class="progress" style="height: 24px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ job.progress_percent|default(0) }}%;" 
                                 data-job-id="{{ job.id }}"
                                 data-job-percent="{{ job.progress_percent }}">
                                <small class="text-white fw-bold">{{ job.progress_percent }}%</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div class="row text-center mb-3">
                        <div class="col-3">
                            <small class="text-muted">Successful</small>
                            <div class="text-success fw-bold">{{ job.successful_items }}</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Failed</small>
                            <div class="text-danger fw-bold">{{ job.failed_items }}</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Skipped</small>
                            <div class="text-warning fw-bold">{{ job.skipped_items }}</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Remaining</small>
                            <div class="text-info fw-bold">{{ job.total_items - job.processed_items }}</div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <button class="btn btn-sm btn-outline-danger" onclick="cancelJob({{ job.id }})">
                        <i class="bi bi-stop-circle"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="alert alert-info mb-4">
    <i class="bi bi-info-circle"></i> No active operations right now.
</div>
{% endif %}

<!-- Recent Operations -->
<div class="mb-4">
    <h5>Recent Operations</h5>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Operation</th>
                    <th>Started</th>
                    <th>Status</th>
                    <th>Success</th>
                    <th>Failed</th>
                    <th>Skipped</th>
                    <th>Duration</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for job in recent_jobs %}
                <tr>
                    <td>
                        <strong class="text-capitalize">{{ job.job_type }}</strong>
                        <br><small class="text-muted">{{ job.parameters|safe }}</small>
                    </td>
                    <td><small>{{ job.created_at.strftime('%m/%d %H:%M') }}</small></td>
                    <td>
                        {% if job.status == 'completed' %}
                        <span class="badge bg-success">COMPLETED</span>
                        {% elif job.status == 'failed' %}
                        <span class="badge bg-danger">FAILED</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ job.status.upper() }}</span>
                        {% endif %}
                    </td>
                    <td><span class="badge bg-success">{{ job.successful_items }}</span></td>
                    <td><span class="badge bg-danger">{{ job.failed_items }}</span></td>
                    <td><span class="badge bg-warning">{{ job.skipped_items }}</span></td>
                    <td>
                        {% if job.completed_at %}
                        <small>{{ (job.completed_at - job.started_at).total_seconds()|int }}s</small>
                        {% else %}
                        <small>-</small>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary" onclick="viewJobDetails({{ job.id }})">
                            <i class="bi bi-eye"></i> Details
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh active jobs
function refreshJobStatus() {
    document.querySelectorAll('.progress-bar').forEach(bar => {
        const jobId = bar.getAttribute('data-job-id');
        if (!jobId) return;
        
        fetch(`{{ url_for('main.get_job_status', job_id='ID') }}`.replace('ID', jobId))
            .then(r => r.json())
            .then(data => {
                bar.style.width = data.progress_percent + '%';
                bar.textContent = data.progress_percent + '%';
                
                // Update stats
                const card = bar.closest('.card');
                // Update if needed
            })
            .catch(e => console.error('Failed to refresh:', e));
    });
}

function cancelJob(jobId) {
    if (confirm('Cancel this operation?')) {
        fetch(`/bulk-job/${jobId}/cancel`, {method: 'POST'})
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Operation cancelled');
                    location.reload();
                }
            });
    }
}

function viewJobDetails(jobId) {
    fetch(`{{ url_for('main.get_job_status', job_id='ID') }}`.replace('ID', jobId))
        .then(r => r.json())
        .then(data => {
            let details = `Job #${data.id}\n`;
            details += `Status: ${data.status}\n`;
            details += `Progress: ${data.processed}/${data.total}\n`;
            details += `Successful: ${data.successful}\n`;
            details += `Failed: ${data.failed}\n`;
            details += `Skipped: ${data.skipped}\n`;
            if (data.results.errors) {
                details += `\nErrors:\n${data.results.errors.slice(0, 5).join('\n')}`;
                if (data.results.errors.length > 5) {
                    details += `\n... and ${data.results.errors.length - 5} more`;
                }
            }
            alert(details);
        });
}

// Refresh every 3 seconds if there are active jobs
if (document.querySelectorAll('.progress-bar').length > 0) {
    setInterval(refreshJobStatus, 3000);
}
</script>
{% endblock %}
